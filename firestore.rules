rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    // Check if user is authenticated
    function signedIn() {
      return request.auth != null;
    }
    
    // Check if userId matches current user
    function isSelf(userId) {
      return signedIn() && userId == request.auth.uid;
    }
    
    // Check if user is a member of the agency
    function isAgencyMember(agencyId) {
      return signedIn() && 
        exists(/databases/$(database)/documents/agencies/$(agencyId)/users/$(request.auth.uid));
    }
    
    // Check if user is admin of the agency
    function isAgencyAdmin(agencyId) {
      return signedIn() && 
        isAgencyMember(agencyId) &&
        getUserRole(agencyId) == 'admin';
    }
    
    // Get user role in agency
    function getUserRole(agencyId) {
      let userDoc = get(/databases/$(database)/documents/agencies/$(agencyId)/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    // Check if user has required role (admin or agent)
    function isAdminOrAgent(agencyId) {
      let role = getUserRole(agencyId);
      return role != null && (role == 'admin' || role == 'agent');
    }
    
    // Check if user has assistant role
    function isAssistant(agencyId) {
      let role = getUserRole(agencyId);
      return role != null && role == 'assistant';
    }
    
    // ============================================================================
    // USER CONTEXT COLLECTION (for bootstrap)
    // ============================================================================
    // This allows users to store their agencyId pointer for fast lookup
    match /userContext/{uid} {
      // User can read/write their own context
      allow read, write: if signedIn() && isSelf(uid);
    }
    
    // ============================================================================
    // AGENCIES COLLECTION
    // ============================================================================
    match /agencies/{agencyId} {
      // Allow creating an agency if user sets createdByUid to their own uid
      allow create: if signedIn() && 
        request.resource.data.createdByUid == request.auth.uid;
      
      // Allow reading agency if user is a member
      allow read: if signedIn() && isAgencyMember(agencyId);
      
      // Allow update/delete only if admin
      allow update, delete: if signedIn() && isAgencyAdmin(agencyId);
      
      // ============================================================================
      // USERS SUBCOLLECTION (agency membership)
      // ============================================================================
      match /users/{userId} {
        // User can create their own membership doc with valid role
        allow create: if signedIn() && 
          isSelf(userId) &&
          request.resource.data.role in ['admin', 'agent', 'assistant'];
        
        // User can read their own membership doc
        // Admins can read all membership docs in their agency
        allow read: if signedIn() && 
          (isSelf(userId) || isAgencyAdmin(agencyId));
        
        // User can update their own doc (but not change role unless admin)
        // Admins can update any membership doc
        // Prevent role escalation: only admins can change roles
        allow update: if signedIn() && (
          // User updating their own doc (but role changes require admin)
          (isSelf(userId) && 
           (request.resource.data.role == resource.data.role || isAgencyAdmin(agencyId))) ||
          // Admin updating any doc
          isAgencyAdmin(agencyId)
        );
        
        // Prevent deletion of membership docs
        allow delete: if false;
      }
      
      // ============================================================================
      // CUSTOMERS COLLECTION
      // ============================================================================
      match /customers/{customerId} {
        // All agency members can read customers
        allow read: if signedIn() && isAgencyMember(agencyId);
        
        // Only agents and admins can create/update customers
        allow create, update: if signedIn() && 
          isAgencyMember(agencyId) &&
          isAdminOrAgent(agencyId);
        
        // Only admins and agents can delete
        allow delete: if signedIn() && 
          isAdminOrAgent(agencyId);
        
        // Notes subcollection
        match /notes/{noteId} {
          allow read: if signedIn() && isAgencyMember(agencyId);
          allow create: if signedIn() && isAgencyMember(agencyId);
          allow update, delete: if signedIn() && isAdminOrAgent(agencyId);
        }
        
        // Policies subcollection
        match /policies/{policyId} {
          allow read: if signedIn() && isAgencyMember(agencyId);
          allow write: if signedIn() && isAdminOrAgent(agencyId);
        }
      }
      
      // ============================================================================
      // CONVERSATIONS COLLECTION
      // ============================================================================
      match /conversations/{conversationId} {
        allow read: if signedIn() && isAgencyMember(agencyId);
        allow create, update: if signedIn() && isAgencyMember(agencyId);
        allow delete: if false; // Keep conversation history
        
        // Messages subcollection
        match /messages/{messageId} {
          allow read: if signedIn() && isAgencyMember(agencyId);
          allow create: if signedIn() && isAgencyMember(agencyId);
          allow update: if signedIn() && isAdminOrAgent(agencyId);
          allow delete: if false; // Keep message history
        }
      }
      
      // ============================================================================
      // TASKS COLLECTION
      // ============================================================================
      match /tasks/{taskId} {
        allow read: if signedIn() && isAgencyMember(agencyId);
        allow create: if signedIn() && isAgencyMember(agencyId);
        allow update: if signedIn() && isAgencyMember(agencyId);
        
        // Assistants can only delete their own tasks
        // Admins and agents can delete any task
        allow delete: if signedIn() && 
          (isAdminOrAgent(agencyId) ||
           (isAssistant(agencyId) && 
            resource.data.assignedToUid == request.auth.uid));
      }
      
      // ============================================================================
      // UPLOADS COLLECTION
      // ============================================================================
      match /uploads/{uploadId} {
        allow read: if signedIn() && isAgencyMember(agencyId);
        allow create: if signedIn() && isAgencyMember(agencyId);
        allow delete: if signedIn() && isAgencyAdmin(agencyId);
      }
      
      // ============================================================================
      // PHONE INDEX COLLECTION (internal use)
      // ============================================================================
      match /phoneIndex/{phoneE164} {
        allow read: if false; // Internal use only
        allow write: if false; // Only via Cloud Functions
      }
      
      // ============================================================================
      // SETTINGS COLLECTION
      // ============================================================================
      match /settings/{settingId} {
        allow read: if signedIn() && isAgencyMember(agencyId);
        allow write: if signedIn() && isAgencyAdmin(agencyId);
      }
      
      // ============================================================================
      // STATS COLLECTION (metrics cache)
      // ============================================================================
      match /stats/{statId} {
        // All agency members can read stats
        allow read: if signedIn() && isAgencyMember(agencyId);
        // Only agents and admins can update stats (for metrics maintenance)
        allow write: if signedIn() && isAdminOrAgent(agencyId);
      }
    }
  }
}
